@{
    ViewData["Title"] = "Request";
}

@using Microsoft.AspNetCore.Http
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
<style>
    .dataTables_filter{
        display:none;

    }
</style>

<section class="content">
    <div class="row">
        <div class="col-12">

            <div class="card card-primary">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 class="card-title trn">Tracker List</h3>
                        </div>
                        <div class="col-md-6 text-right">
                        </div>

                    </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-3">
                            <!-- text input -->
                            <div class="form-group">
                                <label class="trn">OverAll</label>
                                @if (ViewBag.reqType == "4")
                                {
                                    <input type="radio" id="chkOverAll" name="ReqTracker" value="OverAll" onclick="BindTable(4)" checked>
                                }
                                else
                                {
                                    <input type="radio" id="chkOverAll" name="ReqTracker" value="OverAll" onclick="BindTable(4)">
                                }

                            </div>
                        </div>
                        <div class="col-sm-3">
                            <!-- text input -->
                            <div class="form-group">
                                <label class="trn">New Request</label>
                                @if (ViewBag.reqType == "1")
                                {
                                    <input type="radio" id="chkNew" name="ReqTracker" value="New" onclick="BindTable(1)" checked="true">
                                }
                                else
                                {
                                    <input type="radio" id="chkNew" name="ReqTracker" value="New" onclick="BindTable(1)">
                                }

                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="trn">Regular Request</label>
                                @if (ViewBag.reqType == "2")
                                {
                                    <input type="radio" name="ReqTracker" id="chkRegular" value="Regular" onclick="BindTable(2)" checked="true">
                                }
                                else
                                {
                                    <input type="radio" name="ReqTracker" id="chkRegular" value="Regular" onclick="BindTable(2)">
                                }
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="trn">ReCalibration Request</label>
                                @if (ViewBag.reqType == "3")
                                {
                                    <input type="radio" name="ReqTracker"  id="chkReCalibration" value="ReCalibration" onclick="BindTable(3)" checked>
                                }
                                else
                                {
                                    <input type="radio" name="ReqTracker" id="chkReCalibration" value="ReCalibration" onclick="BindTable(3)">
                                }
                            </div>
                        </div>

                    </div>
                    <table id="example2" class="table table-bordered table-striped" style="width:100%;">
                        <thead>
                            <tr>
                                <th class="trn">Request No</th>
                                <th class="trn">Request Date</th>
                                <th class="trn">Sub Section Code</th>
                                <th class="trn">Instrument Name</th>
                                <th class="trn">Instrument Id</th>
                                <th class="trn">Range</th>
                                
                                <th class="trn">Request Type</th>
                                <th class="trn">Status</th>
                                <th class="trn">View</th>
                                <th class="trn">Test</th>
                                <th class="trn">Certificate</th>
                                <th class="trn">Type Of Scope</th>
                            </tr>
                             <tr>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                                <th class="trn"></th>
                               
                            </tr>
                            
                          @*   <tr class="filter">
                               
                                <th class="filtertxt">
                                    <input id="txrequestno" type="text" class="form-control" />
                                </th>
                               
                                <th class="filtertxt">
                                    <input id="txClaimno" type="text" class="form-control" />
                                </th>
                                <th class="filtertxt">
                                    <input id="txInwdate" type="text" class="form-control due-date" />
                                </th>
                                <th class="filtertxt">
                                    <input id="txPartno" type="text" class="form-control" />
                                </th>
                                <th class="filtertxt">
                                    <input id="txPartDesc" type="text" class="form-control" />
                                </th>
                                <th class="filtertxt">
                                    <input id="txReturnTp" type="text" class="form-control" />
                                </th>
                              
                                <th class="filtertxt">
                                    <input id="txGroup" type="text" class="form-control" />
                                </th>
                                <th class="filterdrop"></th>
                                <th class="filtertxt">
                                    <input id="txLoc" type="text" class="form-control" />
                                </th>
                                <th class="filtertxt">
                                    <input id="txReturnCon" type="text" class="form-control" />
                                </th>
                                <th class="filtertxt">
                                    <input id="txPQRNo" type="text" class="form-control" />
                                </th>

                                <th class="filtertxt">
                                    <input id="txPQRNo1" type="text" class="form-control" />
                                </th>

                            </tr> *@

                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
</section>
@* <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

 <script src='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>
*@

<!--Import jQuery before export.js-->
<script type="text/javascript" src="~/js/jquery.min.js"></script>


<!--Data Table-->
<script type="text/javascript" src="~/js/jquery.dataTables.min.js"></script>


<script type="text/javascript">
  
    var RequestNo = '@HttpContextAccessor.HttpContext.Session.GetString("RequestNo")';
    if (RequestNo.length > 1) {
         $.ajax({
            url: '../Instrument/EmailForTracker',
            type: 'POST',
            // data: { instrument: Instrument, Request: Request },
            dataType: "json",
        }).done(function (resultObject) {
           // showSuccess("Data Saved Successfully");
        });
    }

    var filters = [];
    var actions = "pageload";
    $(function () {
        
         BindTable();
    });
    var BindTable = function (response) {
        filters = [];
        var  reqType=response;
        $('#example2').dataTable(
            {
                "bDestroy": true,
                "bProcessing": true,
                "bServerSide": true,
               // "bFilter": true,
               // "sDom": "lrtip",
                "bSortCellsTop": true,
                "sAjaxSource": '../Tracker/GetAllRequestList',
                "fnServerParams": function (aoData) { aoData.push({ "name": "reqType", "value": reqType })
                    aoData.push({ "name": "sscode", "value": $('#txtsearch2').val() })
                    aoData.push({ "name": "instrumentname", "value": $('#txtsearch3').val() })
                    aoData.push({ "name": "instrumentid", "value": $('#txtsearch4').val() })
                    aoData.push({ "name": "status", "value": $('#drpstatus').val() })
                    aoData.push({ "name": "requestno", "value": $('#txtsearch0').val() })//$('#drptypeOfEquipment').val() 
                    aoData.push({ "name": "requestdate", "value": $('#txtsearch1').val() })
                    aoData.push({ "name": "range", "value": $('#txtsearch5').val() })
                    aoData.push({ "name": "typeofrequest", "value": $('#drprequesttype').val() })
                    aoData.push({ "name": "typeofequipment", "value": $('#drpscope').val() })
                    aoData.push({ "name": "actions", "value": actions })
                      
                },
                "fnServerData": function (sSource, aoData, fnCallback) {
                    $.ajax({
                        type: 'GET',
                        url: sSource,
                        data:aoData,
                        "success": function (json) {
                            filters = json.filter;
                            fnCallback(json);
                            if (actions == "pageload") {
                            BindingFilters(filters);
                            }
                        }
                    });
                      
                },
                 
                "aoColumns": [
                    //{ "orderSequence": ["desc", "asc", "asc"] },
                    { "data": "reqestNo", "name": "Request No"},
                    { "data": "lc", "name": "Request Date"},// { "data": "reqDueDate", "name": "Request Date" },
                    { "data": "subSectionCode", "name": "Sub Section Code"},
                    { "data": "instrumentName", "name": "Instrument Name"},
                    { "data": "instrumentIdNo", "name": "Instrument Id"},
                    { "data": "range", "name": "Range"},
                   // { "data": "statusname", "name": "Status"},

                    {
                        "render": function (data, type, row, meta) {
                            var tdTypeofRequest = '';
                            if (row.typeOfRequest == 1) {
                                tdTypeofRequest = "New"
                            }
                            else if (row.typeOfRequest == 2) {
                                tdTypeofRequest = "Regular"
                            }
                            else if (row.typeOfRequest == 3) {
                                tdTypeofRequest = "Recalibration"
                            }
                            else if (row.typeOfRequest == 4) {
                                tdTypeofRequest = "UnQuarantine"
                            }
                            // var linkedit = '<a href="@Url.Action("InstrumentEdit","Instrument")?instrumentId='+row.id+'"><i class="fas fa-edit"></i></a>';
                            return tdTypeofRequest;
                        }
                    },
                    // {"data":"status","name":"Status"},
                    {
                        "render": function (data, type, row, meta) {
                            var tdStatus = '';
                            if (row.status == 26) {
                                tdStatus = "Requested"
                            }
                            else if (row.status == 27) {
                                tdStatus = "Approved"
                            }
                            else if (row.status == 28) {
                                tdStatus = "Request Rejected"
                            }
                            else if (row.status == 28 && row.Result == "Result") {
                                tdStatus = "Request Rejected"
                            }
                            else if (row.status == 29 && row.labResult != "Rejected" && row.typeOfEquipment == 'External') {
                                tdStatus = "Verification done"
                            }
                            //else if (row.status == 29 && row.labResult != "Rejected") {
                            else if (row.status == 29 && row.typeOfEquipment == 'Internal'){
                                    tdStatus = "Calibration done"
                            }
                            else if (row.status == 30) {
                                tdStatus = "Closed"
                            }
                            else if (row.status == 31 && row.typeOfEquipment == 'Internal') {
                                tdStatus = "Calibration Rejected"
                            }
                            else if (row.status == 31 && row.typeOfEquipment == 'External') {
                                tdStatus = "Verification Rejected"
                            }
                            return tdStatus;
                        }
                    },
                    // {"data":"idNo","name":"View"},
                    {
                        "render": function (data, type, row, meta) {
                            var tdView = '<i class="fas fa-eye" style = "cursor:pointer" id = ' + row.id + ' onclick = "GetRequestDetails(this)"></i>'
                            return tdView;
                        }
                    },
                    {
                        data: 'observationTemplate',
                        "render": function (data, type, row, meta) {
                            console.log("----------------");
                            console.log(data);
                                console.log(row.observationTemplate)
                             console.log("----------------");
                            var tdTest = '';
                            var userRoleId = @HttpContextAccessor.HttpContext.Session.GetString("UserRoleId");
                           
                            if ((userRoleId == 2 || userRoleId == 3 || userRoleId == 4) && (row.status == 27 || row.status == 29 || row.status == 30 || row.status == 31) && row.typeOfEquipment != 'External') {
                                if ((row.templateId > 0) && (row.status == 27))//&& row.
                                 { 
                                    tdTest = '<span title="Approved!"><a style="color:orange" href="@Url.Action("InternalObservation","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'
                                 }
                                else if  (row.status == 30) {

                                    tdTest = '<span title="closed!"><a style="color:green" href="@Url.Action("InternalObservation","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'

                                 }
                                else if (row.status == 31) {

                                    tdTest = '<span title="Calibration Rejected!"><a style="color:red" href="@Url.Action("InternalObservation","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'

                                }
                                 else if (row.status == 29) {

                                    tdTest = '<span title="Calibration Done!"><a style="color:yellow" href="@Url.Action("InternalObservation","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'

                                }
                                else  {

                                    tdTest = '<span title="Requested!"><a href="@Url.Action("InternalObservation","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'

                                }
                            }
                            else if ((row.userRoleId == 2 || row.userRoleId == 3 || row.userRoleId == 4) && (row.status == 27 || row.status == 29 || row.status == 30) && row.typeOfEquipment == 'External') {
                               
                                //tdTest = '<a href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i>'
                                if ((row.templateId > 0) && (row.status == 27))//&& row.
                                {
                                   
                                    tdTest = '<span title="Verification Approved!"><a style="color:orange" href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i>'
                                //for commit test                                
                                }
                                else if  (row.status == 30){

                                    tdTest = '<span title="Verification Closed!"><a style="color:green" href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i>'

                                }
                                else if (row.status == 31) {

                                    tdTest = '<span title="Verification Rejected!"><a style="color:red" href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i>'

                                }
                                  else if (row.status == 29) {

                                        tdTest = '<span title="Verification Done!"><a style="color:yellow" href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'

                                }
                                else {

                                    tdTest = '<span title="Requested!"><a href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i></span>'

                                }
                            
                            }
                           
                            return tdTest;
                        }
                    },
                    {
                        "render": function (data, type, row, meta) {
                            var tdCertificate = '';
                            if (row.status == 29 || row.status == 30 || row.status == 31)//(item.templateReviewStatus == 1 || item.templateReviewStatus == 2 || (item.exObsTemplateReviewStatus == 1 && item.status != 27) || item.exObsTemplateReviewStatus == 2) )
                            {
                                tdCertificate = '<a href="@Url.Action("ViewCertification","Certification")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '"><i class="fas fa-user-graduate" style = "cursor:pointer"></i>'
                            }
                           
                            return tdCertificate;
                        }
                    },

                    { "data": "typeOfEquipment", "name": "Type Of Scope" },//, "sortable": true, "orderable": true
                ],
             
            "createdRow": function (row, data, dataIndex) {
             
                if (data["reqDueDate"] != null) {

                        var edate=new Date(data["reqDueDate"]);
                        var currentdate = new Date();
                        
                        if (edate < currentdate) //&& (item.status != 30))
                        {
                          
                            $(row).css('background-color', '#fbefef');
                        }
                        else {
                        
                        }
                        }
                },
                "columnDefs": [ {
    "targets":9,
    "createdCell": function (td, cellData, rowData, row, col) {
      
    }
  } ],
                "pageLength": "100",
               
                "language": {
                   
                    "processing":
                        '<i class="fa fa-spinner fa-spin fa-3x fa-fw" style="color:#2a2b2b;"></i><span class="sr-only">Loading...</span> '
                },
                 dom: "<'row'<'col-sm-3'l><'col-sm-3'f><'col-sm-6'p>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-5'i><'col-sm-7'p>>",

            });
        
    }

    function Drpstatus(val) {
         var table = $('#example2').DataTable();
        actions = "click";
        if (table.search() !== val || val == "") {
              table.search(val).draw();
           
                  
         }
     }
     function drpreqtype(val) {
       // alert(val);
        actions = "click";
         var table = $('#example2').DataTable();
        if (table.search() !== val || val == "") {
         table.search(val).draw();
           
        }
     }
     function Drpscop(val) {
        // alert(val);
        actions = "click";
         var table = $('#example2').DataTable();
        if (table.search() !== val || val=="") {
             table.search(val).draw();
           
        }
     }

    function BindingFilters(filters) {
        $('#txtsearch0').val(filters.requestno);
        $('#txtsearch1').val(filters.requestdate);
        $('#txtsearch2').val(filters.sscode);
        $('#txtsearch3').val(filters.instrumentname);
        $('#txtsearch4').val(filters.instrumentid);
        $('#txtsearch4').val(filters.range);
        $('#drprequesttype').val(filters.typeofrequest);
        $('#drpstatus').val(filters.status);
        $('#drpscope').val(filters.typeofequipment);
       
    }

     $(document).ready(function() {


   $("#example2 thead tr:eq(1) th").each(function (i) {
        var title1 = $(this).text();
        var title = title1.trim();
     if(i==0 ||i==1 || i==2 || i==3|| i==4|| i==5)
     {
       $(this).html('<input id="txtsearch'+i+'" style="width: 100px;"  class="form-control filter" type="text" placeholder="Search" />');

     }
    else if(i==7)
      {
    $(this).html('<select name=""  id="drpstatus"  class="form-control" onchange="Drpstatus(this.value)" </select>');

      }
      else if( i==6)
      {
    $(this).html('<select name=""  id="drprequesttype"  class="form-control" onchange="drpreqtype(this.value)" </select>');

      }
      else if(i==11)
      {
    $(this).html('<select name=""  id="drpscope"  class="form-control" onchange="Drpscop(this.value)" </select>');

      }
     else
     {
       $(this).html('<input  style="width: auto;display:none"  class="form-control filter" type="text" placeholder="Search" />');

     }
    });

    var option=[];
        option.push('<option value="">All</option>')
        option.push('<option value="26">Requested</option>')
        option.push('<option value="27">Approved</option>')
        option.push('<option value="28">Request Rejected</option>')
        option.push('<option value="32">Verification done</option>')
        option.push('<option value="29">Calibration done</option>')
        option.push('<option value="30">Closed</option>')
        option.push('<option value="31">Calibration Rejected</option>')
        option.push('<option value="33">Verificationration Rejected</option>')
        
        $('#drpstatus').append(option);
        
        var optionscope=[];
        optionscope.push('<option value="">All</option>')
        optionscope.push('<option value="Internal">Internal</option>')
        optionscope.push('<option value="External">External</option>')
         $('#drpscope').append(optionscope);

        var optionreqtype=[];
        optionreqtype.push('<option value="">All</option>')
        optionreqtype.push('<option value="1">New</option>')
        optionreqtype.push('<option value="2">Regular</option>')
         optionreqtype.push('<option value="3">ReCalibration</option>')
         $('#drprequesttype').append(optionreqtype);

     

        var table = $('#example2').DataTable();
           table.columns().every(function () {
         
          $('input').on('keyup change', function () {
                actions = "click";
                if (table.search() !== this.value) {
                	table.search(this.value).draw();
                  
                }
            });
        });

 

      })
  
</script>
  