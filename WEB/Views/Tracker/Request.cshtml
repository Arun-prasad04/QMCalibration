@{
    ViewData["Title"] = "Request";
}

@using Microsoft.AspNetCore.Http
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<section class="content">
    <div class="row">
        <div class="col-12">

            <div class="card card-primary">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 class="card-title trn">Tracker List</h3>
                        </div>
                        <div class="col-md-6 text-right">
                        </div>

                    </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-3">
                            <!-- text input -->
                            <div class="form-group">
                                <label class="trn">OverAll</label>
                                @if (ViewBag.reqType == 4)
                                {
                                    <input type="radio" name="ReqTracker" value="OverAll" onclick="getrequest(5)" checked="true">
                                }
                                else
                                {
                                    <input type="radio" name="ReqTracker" value="OverAll" onclick="getrequest(5)">
                                }

                            </div>
                        </div>
                        <div class="col-sm-3">
                            <!-- text input -->
                            <div class="form-group">
                                <label class="trn">New Request</label>
                                @if (ViewBag.reqType == 1)
                                {
                                    <input type="radio" name="ReqTracker" value="New" onclick="getrequest(1)" checked="true">
                                }
                                else
                                {
                                    <input type="radio" name="ReqTracker" value="New" onclick="getrequest(1)">
                                }

                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="trn">Regular Request</label>
                                @if (ViewBag.reqType == 2)
                                {
                                    <input type="radio" name="ReqTracker" value="Regular" onclick="getrequest(2)" checked="true">
                                }
                                else
                                {
                                    <input type="radio" name="ReqTracker" value="Regular" onclick="getrequest(2)">
                                }
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="trn">ReCalibration Request</label>
                                @if (ViewBag.reqType == 3)
                                {
                                    <input type="radio" name="ReqTracker" value="ReCalibration" onclick="getrequest(3)" checked="true">
                                }
                                else
                                {
                                    <input type="radio" name="ReqTracker" value="ReCalibration" onclick="getrequest(3)">
                                }
                            </div>
                        </div>

                    </div>
                    <table id="example2" class="table table-bordered table-striped" style="width:100%;">
                        <thead>
                            <tr>
                                <th class="trn">Request No</th>
                                <th class="trn">Request Date</th>
                                <th class="trn">Sub Section Code</th>
                                <th class="trn">Instrument Name</th>
                                <th class="trn">Instrument Id</th>
                                <th class="trn">Range</th>
                                <th class="trn">Request Type</th>
                                <th class="trn">Status</th>
                                <th class="trn">View</th>
                                <th class="trn">Test</th>
                                <th class="trn">Certificate</th>
                                <th class="trn">Type Of Scope</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
</section>
@* <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

 <script src='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>
*@

<!--Import jQuery before export.js-->
<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>


<!--Data Table-->
<script type="text/javascript" src=" https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>


<script type="text/javascript">
    $(function () {
        BindTable();
    });
    var BindTable = function (response) {
        $('#example2').dataTable(
            {
                "bProcessing": true,
                "bServerSide": true,
                // "bInfo": true,
                "sAjaxSource": '../Tracker/GetAllRequestList',
                "fnServerData": function (sSource, aoData, fnCallback) {// }, oSettings) {
                    $.ajax({
                        type: 'GET',
                        url: sSource,
                        data: aoData,
                        success: fnCallback
                    })
                    //console.log(aoData);
                },

                "aoColumns": [

                    { "data": "reqestNo", "name": "Request No" },
                    { "data": "lc", "name": "Request Date" },// { "data": "reqDueDate", "name": "Request Date" },
                    { "data": "subSectionCode", "name": "Sub Section Code" },
                    { "data": "instrumentName", "name": "Instrument Name" },
                    { "data": "instrumentIdNo", "name": "Instrument Id" },
                    { "data": "range", "name": "Range" },

                    {
                        "render": function (data, type, row, meta) {
                            var tdTypeofRequest = '';
                            if (row.typeOfRequest == 1) {
                                tdTypeofRequest = "New"
                            }
                            else if (row.typeOfRequest == 2) {
                                tdTypeofRequest = "Regular"
                            }
                            else if (row.typeOfRequest == 3) {
                                tdTypeofRequest = "Recalibration"
                            }
                            else if (row.typeOfRequest == 4) {
                                tdTypeofRequest = "UnQuarantine"
                            }
                            // var linkedit = '<a href="@Url.Action("InstrumentEdit","Instrument")?instrumentId='+row.id+'"><i class="fas fa-edit"></i></a>';
                            return tdTypeofRequest;
                        }
                    },
                    // {"data":"status","name":"Status"},
                    {
                        "render": function (data, type, row, meta) {
                            var tdStatus = '';
                            if (row.status == 26) {
                                tdStatus = "Requested"
                            }
                            else if (row.status == 27) {
                                tdStatus = "Approved"
                            }
                            else if (row.status == 28) {
                                tdStatus = "Request Rejected"
                            }
                            else if (row.status == 28 && row.Result == "Result") {
                                tdStatus = "Request Rejected"
                            }
                            else if (row.status == 29 && row.labResult != "Rejected" && row.typeOfEquipment == 'External') {
                                tdStatus = "Verification done"
                            }
                            else if (row.status == 29 && row.labResult != "Rejected") {
                                tdStatus = "Calibration done"
                            }
                            else if (row.status == 30) {
                                tdStatus = "Closed"
                            }
                            else if (row.status == 31) {
                                tdStatus = "Calibration Rejected"
                            }

                            return tdStatus;
                        }
                    },
                    // {"data":"idNo","name":"View"},
                    {
                        "render": function (data, type, row, meta) {
                            var tdView = '<i class="fas fa-eye" style = "cursor:pointer" id = ' + row.id + ' onclick = "GetRequestDetails(this)"></i>'
                            return tdView;
                        }
                    },
                    {
                        "render": function (data, type, row, meta) {

                            var tdTest = '';
                            var userRoleId = @HttpContextAccessor.HttpContext.Session.GetString("UserRoleId");
                            // console.log("userRoleId"+userRoleId);
                            // console.log(row);//+','+data+','+type+','+meta);

                            if ((userRoleId == 2 || userRoleId == 3 || userRoleId == 4) && (row.status == 27 || row.status == 29 || row.status == 30 || row.status == 31) && row.typeOfEquipment != 'External') {

                                tdTest = '<a href="@Url.Action("InternalObservation","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i>'

                            }
                            else if ((row.userRoleId == 2 || row.userRoleId == 3 || row.userRoleId == 4) && (row.status == 27 || row.status == 29 || row.status == 30) && row.typeOfEquipment == 'External') {

                                tdTest = '<a href="@Url.Action("ExternalObs","Observation")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '" ><i class="fas fa-check-circle" style = "cursor:pointer"></i>'
                            }
                            // else {
                            //     tdTest = ""
                            // }
                            return tdTest;
                        }
                    },
                    {
                        "render": function (data, type, row, meta) {
                            var tdCertificate = '';
                            if (row.status == 29 || row.status == 30 || row.status == 31)//(item.templateReviewStatus == 1 || item.templateReviewStatus == 2 || (item.exObsTemplateReviewStatus == 1 && item.status != 27) || item.exObsTemplateReviewStatus == 2) )
                            {
                                tdCertificate = '<a href="@Url.Action("ViewCertification","Certification")?requestId=' + row.id + '&instrumentId=' + row.instrumentId + '"><i class="fas fa-user-graduate" style = "cursor:pointer"></i>'
                            }
                            // else {
                            //     tdCertificate = ''
                            //     }
                            return tdCertificate;
                        }
                    },

                    { "data": "typeOfEquipment", "name": "Type Of Scope" },
                ],

                "pageLength": "100",
                "language": {
                    //"emptyTable": "No record found.",
                    "processing":
                        '<i class="fa fa-spinner fa-spin fa-3x fa-fw" style="color:#2a2b2b;"></i><span class="sr-only">Loading...</span> '
                },


            });
    }


            // function binding(selectedValue, Startingrow, Endingrow, Search) {

            //     $('#example2').dataTable({

            //             "ajax":{
            //                 type: 'POST',
            //                 url: '../Tracker/GetAllRequestList',
            //                 dataType: 'json',
            //             },
            //             "columns":[
            //                 {"data":"Request No":"name":"ReqestNo"}
            //                 {"data":"Request Date":"name":"RequestDate"}
            //                 {"data":"Sub Section Code":"name":"SubSectionCode"}
            //                 {"data":"Instrument Name":"name":"InstrumentName"}
            //                 {"data":"Instrument Id":"name":"IdNo"}
            //             ],
            //             "serverside":true,
            //             "order":[0."asc"],

            //     });
            // }
</script>
